<!-- Start Hero Section -->
<div class="hero">
  <div class="container">
    <div class="row justify-content-between">
      <div class="col-lg-5">
        <div class="intro-excerpt">
          <h1>Checkout</h1>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- End Hero Section -->

<!-- Checkout Form (Entire form across both columns) -->
<div class="container my-5">
  <form #checkoutForm="ngForm" (ngSubmit)="placeOrder(checkoutForm)" novalidate>
    <div class="row g-4">


      <!-- Left: Billing Address -->
      <div class="col-md-6">
        <!-- Billing Address -->
        <div class="card shadow-sm border-0 rounded-4 mb-4">
          <div class="card-body p-4">
            <h2 class="mb-4">Billing Address</h2>

            <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label">First Name</label>
                <input type="text" class="form-control" name="billingFirstName" [(ngModel)]="billingAddress.firstName"
                  #billingFirstName="ngModel" required
                  [class.is-invalid]="(billingFirstName.invalid && (billingFirstName.touched || submitted)) || backendErrors['firstName']" />
                <div *ngIf="getFieldError(billingFirstName, backendErrors) && (billingFirstName.touched || submitted)"
                  class="text-danger mt-1">
                  {{ getFieldError(billingFirstName, backendErrors) }}
                </div>
              </div>

              <div class="col-md-6">
                <label class="form-label">Last Name</label>
                <input type="text" class="form-control" name="billingLastName" [(ngModel)]="billingAddress.lastName"
                  #billingLastName="ngModel" required
                  [class.is-invalid]="(billingLastName.invalid && (billingLastName.touched || submitted)) || backendErrors['lastName']" />
                <div *ngIf="getFieldError(billingLastName, backendErrors) && (billingLastName.touched || submitted)"
                  class="text-danger mt-1">
                  {{ getFieldError(billingLastName, backendErrors) }}
                </div>
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">Phone</label>
              <input type="tel" class="form-control" name="billingPhone" [(ngModel)]="billingAddress.phone"
                #billingPhone="ngModel" required pattern="[0-9]{10}"
                [class.is-invalid]="(billingPhone.invalid && (billingPhone.touched || submitted)) || backendErrors['phone']" />
              <div *ngIf="getFieldError(billingPhone, backendErrors) && (billingPhone.touched || submitted)"
                class="text-danger mt-1">
                {{ getFieldError(billingPhone, backendErrors) }}
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">Email</label>
              <input type="email" class="form-control" name="billingEmail" [(ngModel)]="billingAddress.email"
                #billingEmail="ngModel" required
                [class.is-invalid]="(billingEmail.invalid && (billingEmail.touched || submitted)) || backendErrors['email']" />
              <div *ngIf="getFieldError(billingEmail, backendErrors) && (billingEmail.touched || submitted)"
                class="text-danger mt-1">
                {{ getFieldError(billingEmail, backendErrors) }}
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">Address</label>
              <input type="text" class="form-control" name="billingAddress" [(ngModel)]="billingAddress.address"
                #billingAddressField="ngModel" required
                [class.is-invalid]="(billingAddressField.invalid && (billingAddressField.touched || submitted)) || backendErrors['address']" />
              <div
                *ngIf="getFieldError(billingAddressField, backendErrors) && (billingAddressField.touched || submitted)"
                class="text-danger mt-1">
                {{ getFieldError(billingAddressField, backendErrors) }}
              </div>
            </div>

            <div class="row mb-3">
              <div class="col-md-5">
                <label class="form-label">City</label>
                <input type="text" class="form-control" name="billingCity" [(ngModel)]="billingAddress.city"
                  #billingCity="ngModel" required
                  [class.is-invalid]="(billingCity.invalid && (billingCity.touched || submitted)) || backendErrors['city']" />
                <div *ngIf="getFieldError(billingCity, backendErrors) && (billingCity.touched || submitted)"
                  class="text-danger mt-1">
                  {{ getFieldError(billingCity, backendErrors) }}
                </div>
              </div>

              <div class="col-md-4">
                <label class="form-label">State</label>
                <select class="form-select" name="billingState" [(ngModel)]="billingAddress.state"
                  #billingState="ngModel" required
                  [class.is-invalid]="(billingState.invalid && (billingState.touched || submitted)) || backendErrors['state']">
                  <option value="">Choose...</option>
                  <option value="MH">Maharashtra</option>
                  <option value="DL">Delhi</option>
                </select>
                <div *ngIf="getFieldError(billingState, backendErrors) && (billingState.touched || submitted)"
                  class="text-danger mt-1">
                  {{ getFieldError(billingState, backendErrors) }}
                </div>
              </div>

              <div class="col-md-3">
                <label class="form-label">Postal Code</label>
                <input type="text" class="form-control" name="billingPostalCode" [(ngModel)]="billingAddress.postalCode"
                  #billingPostalCode="ngModel" required pattern="[0-9]{6}"
                  [class.is-invalid]="(billingPostalCode.invalid && (billingPostalCode.touched || submitted)) || backendErrors['postalCode']" />
                <div *ngIf="getFieldError(billingPostalCode, backendErrors) && (billingPostalCode.touched || submitted)"
                  class="text-danger mt-1">
                  {{ getFieldError(billingPostalCode, backendErrors) }}
                </div>
              </div>
            </div>
          </div>
        </div>



        <!-- Shipping Address -->
        <div class="card shadow-sm border-0 rounded-4">
          <div class="card-body p-4">
            <div class="form-check mb-4 d-flex align-items-center">
              <input class="form-check-input me-2" type="checkbox" id="sameAsShipping" [(ngModel)]="sameAsShipping"
                name="sameAsShipping" (change)="copyShippingToBilling()" />
              <label class="form-check-label " for="sameAsShipping" style="margin-top: 2px;">
                Billing same as shipping address
              </label>
            </div>

            <h2 class="mb-4">Shipping Address</h2>

            <!-- Repeat the same field structure but use shippingAddress.* and #shipping* refs -->
            <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label">First Name</label>
                <input type="text" class="form-control" name="shippingFirstName" [(ngModel)]="shippingAddress.firstName"
                  #shippingFirstName="ngModel" required
                  [class.is-invalid]="shippingFirstName.invalid && (shippingFirstName.touched || submitted)" />
                <div *ngIf="shippingFirstName.invalid && (shippingFirstName.touched || submitted)"
                  class="text-danger mt-1">
                  First name is required.
                </div>
              </div>

              <div class="col-md-6">
                <label class="form-label">Last Name</label>
                <input type="text" class="form-control" name="shippingLastName" [(ngModel)]="shippingAddress.lastName"
                  #shippingLastName="ngModel" required
                  [class.is-invalid]="shippingLastName.invalid && (shippingLastName.touched || submitted)" />
                <div *ngIf="shippingLastName.invalid && (shippingLastName.touched || submitted)"
                  class="text-danger mt-1">
                  Last name is required.
                </div>
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">Phone</label>
              <input type="tel" class="form-control" name="shippingPhone" [(ngModel)]="shippingAddress.phone"
                #shippingPhone="ngModel" required pattern="[0-9]{10}"
                [class.is-invalid]="shippingPhone.invalid && (shippingPhone.touched || submitted)" />
              <div *ngIf="shippingPhone.invalid && (shippingPhone.touched || submitted)" class="text-danger mt-1">
                Enter valid 10-digit phone number.
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">Email</label>
              <input type="email" class="form-control" name="shippingEmail" [(ngModel)]="shippingAddress.email"
                #shippingEmail="ngModel" required
                [class.is-invalid]="shippingEmail.invalid && (shippingEmail.touched || submitted)" />
              <div *ngIf="shippingEmail.invalid && (shippingEmail.touched || submitted)" class="text-danger mt-1">
                Enter a valid email.
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">Address</label>
              <input type="text" class="form-control" name="shippingAddress" [(ngModel)]="shippingAddress.address"
                #shippingAddressField="ngModel" required
                [class.is-invalid]="shippingAddressField.invalid && (shippingAddressField.touched || submitted)" />
              <div *ngIf="shippingAddressField.invalid && (shippingAddressField.touched || submitted)"
                class="text-danger mt-1">
                Address is required.
              </div>
            </div>

            <div class="row mb-3">
              <div class="col-md-5">
                <label class="form-label">City</label>
                <input type="text" class="form-control" name="shippingCity" [(ngModel)]="shippingAddress.city"
                  #shippingCity="ngModel" required
                  [class.is-invalid]="shippingCity.invalid && (shippingCity.touched || submitted)" />
                <div *ngIf="shippingCity.invalid && (shippingCity.touched || submitted)" class="text-danger mt-1">
                  City is required.
                </div>
              </div>

              <div class="col-md-4">
                <label class="form-label">State</label>
                <select class="form-select" name="shippingState" [(ngModel)]="shippingAddress.state"
                  #shippingState="ngModel" required
                  [class.is-invalid]="shippingState.invalid && (shippingState.touched || submitted)">
                  <option value="">Choose...</option>
                  <option value="MH">Maharashtra</option>
                  <option value="DL">Delhi</option>
                </select>
                <div *ngIf="shippingState.invalid && (shippingState.touched || submitted)" class="text-danger mt-1">
                  State is required.
                </div>
              </div>

              <div class="col-md-3">
                <label class="form-label">Postal Code</label>
                <input type="text" class="form-control" name="shippingPostalCode"
                  [(ngModel)]="shippingAddress.postalCode" #shippingPostalCode="ngModel" required pattern="[0-9]{6}"
                  [class.is-invalid]="shippingPostalCode.invalid && (shippingPostalCode.touched || submitted)" />
                <div *ngIf="shippingPostalCode.invalid && (shippingPostalCode.touched || submitted)"
                  class="text-danger mt-1">
                  Enter valid 6-digit code.
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>


      <!-- Right: Order Summary + Payment Options -->
      <!-- Right: Order Summary and Payment (Split into two cards) -->
      <div class="col-md-6">

        <!-- ðŸ§¾ Order Summary Card -->
        <div class="card shadow-sm border-0 rounded-4 mb-4">
          <div class="card-body p-4">
            <h4 class="mb-4 border-bottom pb-2">Order Summary</h4>

            <!-- Cart Items -->
            <div *ngFor="let item of cartItems" class="d-flex mb-3 border-bottom pb-2">
              <img [src]="getImageUrl(item.Product.img)" class="me-3 rounded"
                style="width: 60px; height: 60px; object-fit: cover;" />
              <div class="flex-grow-1">
                <div class="fw-semibold">{{ item.Product.name }}</div>
                <div class="small text-muted">Qty: {{ item.quantity }}</div>
              </div>
              <div class="fw-bold">{{ format(item.Product.price * item.quantity) }}</div>
            </div>

            <!-- Price Summary -->
            <hr />
            <div class="d-flex justify-content-between mb-2">
              <div>Subtotal</div>
              <div>{{ format(subtotal) }}</div>
            </div>
            <div class="d-flex justify-content-between">
              <div class="text-dark">Discount</div>
              <strong class="text-success">- {{ format(discount) }}</strong>
            </div>

            <div class="d-flex justify-content-between mt-3 border-top pt-3 fw-bold fs-5">
              <div>Total</div>
              <div>{{ format(total) }}</div>
            </div>
          </div>
        </div>

        <!-- ðŸ’³ Payment Card -->
        <div class="card shadow-sm border-0 rounded-4">
          <div class="card-body p-4">
            <h4 class="mb-3 border-bottom pb-2">Payment Method</h4>

            <!-- Radio Buttons -->
            <div class="mb-3">
              <div class="form-check">
                <input class="form-check-input" type="radio" name="paymentMethod" value="stripe"
                  [(ngModel)]="selectedPayment" (change)="onPaymentChange()" id="paymentStripe" />
                <label class="form-check-label" for="paymentStripe">Credit/Debit Card (Stripe)</label>
              </div>

              <div class="form-check">
                <input class="form-check-input" type="radio" name="paymentMethod" value="paypal"
                  [(ngModel)]="selectedPayment" (change)="onPaymentChange()" id="paymentPaypal" />
                <label class="form-check-label" for="paymentPaypal">PayPal</label>
              </div>

              <div class="form-check">
                <input class="form-check-input" type="radio" name="paymentMethod" value="cod"
                  [(ngModel)]="selectedPayment" (change)="onPaymentChange()" id="paymentCOD" />
                <label class="form-check-label" for="paymentCOD">Cash on Delivery</label>
              </div>
            </div>

            <!-- Stripe Payment -->
            <div *ngIf="selectedPayment === 'stripe'" class="mt-3">
              <label class="form-label">Card Payment</label>
              <div class="border rounded p-3 bg-light" id="card-element"></div>
              <div *ngIf="cardError" class="text-danger mt-2 small">{{ cardError }}</div>
            </div>

            <!-- PayPal Button -->
            <div *ngIf="selectedPayment === 'paypal'" class="mt-4">
              <h5 class="mb-2">Pay with PayPal</h5>
              <div id="paypal-button-container"></div>
            </div>

            <!-- Submit Button (Stripe or COD only) -->
            <button *ngIf="selectedPayment !== 'paypal'" type="submit" class="btn btn-dark w-100 mt-4"
              [disabled]="loading">
              <span *ngIf="loading" class="spinner-border spinner-border-sm me-2"></span>
              {{ loading ? 'Processing...' : 'Pay & Place Order' }}
            </button>


            <!-- Success Message -->
            <div *ngIf="successMessage" class="alert alert-success mt-3">
              {{ successMessage }}
            </div>
          </div>
        </div>



      </div>

    </div>
  </form>
</div>
